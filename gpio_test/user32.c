/**
 * user32.c
 *
 * Author: Kenta Ishii
 * License: MIT
 * License URL: https://opensource.org/licenses/MIT
 *
 */

/**
 * Usage
 * 1. Place `gpio32_gpioplay` on FIQ/IRQ Handler which will be triggered with any timer.
 * 2. Place `_gpioset` with needed arguments in `user32.c`.
 * 3. GPIO sequence automatically runs with the assigned values.
 * 4. If you want to stop the GPIO sequence, use `_gpioclear`. Constant 1 of its argument will stay current status of GPIO.
 */

/**
 * GPIO sequence is made of 32-bit Blocks. One Block means one beat.
 * Bit[0]: GPIO 0 Output Low(0)/High(1)
 * Bit[1]: GPIO 1 Output Low(0)/High(1)
 * ...
 * Bit[29]: GPIO 29 Output Low(0)/High(1)
 * Bit[30]: Stay Prior Status of GPIO Which Are Assigned as Zero in the Block
 * Bit[31]: Always Need of Set(1)
 * Note that if a beat is all zero, this beat means the end of sequence.  
 */

#include "system32.h"
#include "system32.c"

/* Output gpio2-gpio5 */
gpio_sequence gpio[] =
{
	0b10000000000000000000000000111100,
	0b10000000000000000000000000111100,
	0b10000000000000000000000000111100,
	0b10000000000000000000000000111100,
	0b10000000000000000000000000111100,
	0b10000000000000000000000000000100,
	0b10000000000000000000000000001000,
	0b10000000000000000000000000010000,
	0b10000000000000000000000000100000,
	0b10000000000000000000000000010000,
	0b10000000000000000000000000001000,
	0b10000000000000000000000000000100,
	0b10000000000000000000000000001100,
	0b10000000000000000000000000110000,
	0b10000000000000000000000000000000,
	0b10000000000000000000000000000000,
	0b10000000000000000000000000000000,
	0b10000000000000000000000000000000,
	0b10000000000000000000000000000000,
	0b10000000000000000000000000000000,
	0b11000000000000000000000000000100,
	0b11000000000000000000000000000000,
	0b11000000000000000000000000000000,
	0b11000000000000000000000000001000,
	0b11000000000000000000000000000000,
	0b11000000000000000000000000000000,
	0b11000000000000000000000000010000,
	0b11000000000000000000000000000000,
	0b11000000000000000000000000000000,
	0b11000000000000000000000000100000,
	0b11000000000000000000000000000000,
	0b11000000000000000000000000000000,
	0b10000000000000000000000000000000,
	0b10000000000000000000000000000000,
	0b10000000000000000000000000111100,
	0b10000000000000000000000000000000,
	0b10000000000000000000000000111100,
	0b10000000000000000000000000000000,
	0b10000000000000000000000000111100,
	0b10000000000000000000000000000000,
	0b10000000000000000000000000111100,
	0b10000000000000000000000000000000,
	0
};

void _user_start()
{
	while(true) {
		_gpioset( gpio, gpio32_gpiolen( gpio ) , 0, -1 );
		while( ! _gpio_detect( 27 ) ) {
		}
		_gpioclear( 1 );
		_sleep( 1000000 );
	}
}
